import { useState, useEffect } from "react";

export default function RoletaKonfigurator() {
  const [sirka, setSirka] = useState(1500);
  const [vyska, setVyska] = useState(1600);
  const [kusy, setKusy] = useState(1);
  const [boxColor, setBoxColor] = useState("bílá");
  const [guideColor, setGuideColor] = useState("bílá");
  const [pancierColor, setPancierColor] = useState("bílá");
  const [endColor, setEndColor] = useState("bílá");
  const [guideType, setGuideType] = useState("PP53");
  const [orderItems, setOrderItems] = useState([]);
  const [accessories, setAccessories] = useState({});

  const priceTable = {
    "1500x1600": 9999,
    "2000x2000": 12000,
    "2500x2000": 15000,
  };

  const accessoriesList = [
    { id: "ovladac1", name: "Dálkový ovladač 1-kanálový", price: 500 },
    { id: "ovladac5", name: "Dálkový ovladač 5-kanálový", price: 1200 },
    { id: "wifimodul", name: "Wi-Fi modul", price: 2500 },
  ];

  const round100 = (value) => Math.ceil(value / 100) * 100;

  const getMinBoxSize = (v) => {
    if (v <= 1600) return 150;
    if (v <= 2080) return 165;
    if (v <= 2590) return 180;
    return 205;
  };

  useEffect(() => {
    if (sirka > 2900) {
      setGuideType("PP68");
    }
  }, [sirka]);

  const calcPrice = (s, v, kusy, guideType, colors) => {
    const sR = round100(s);
    const vR = round100(v);
    const key = `${sR}x${vR}`;

    let base = priceTable[key] || 10000;
    let extra = 0;

    if (colors.includes("zlatý dub")) {
      extra += 2000;
    }

    extra += (sR / 1000) * 980;
    if (guideType === "PP53") {
      extra += (vR / 1000) * 2 * 152;
    } else {
      extra += (vR / 1000) * 2 * 265;
    }
    extra += (sR * vR) / 1000000 * 130;
    extra += (sR / 1000) * 220;

    const cenaBezDPH = (base + extra) * kusy;
    const cenaSDPH = cenaBezDPH * 1.21;

    return { cenaBezDPH, cenaSDPH };
  };

  const { cenaBezDPH, cenaSDPH } = calcPrice(sirka, vyska, kusy, guideType, [boxColor, guideColor, pancierColor, endColor]);

  const minBoxSize = getMinBoxSize(vyska);

  const colors = ["bílá", "stříbrná", "antracit", "hnědá", "tmavě hnědá", "zlatý dub"];

  const addToOrder = () => {
    const item = {
      id: Date.now(),
      sirka,
      vyska,
      kusy,
      minBoxSize,
      boxColor,
      guideColor,
      pancierColor,
      endColor,
      guideType,
      ...calcPrice(sirka, vyska, kusy, guideType, [boxColor, guideColor, pancierColor, endColor])
    };
    setOrderItems([...orderItems, item]);
  };

  const updateItem = (id, field, value) => {
    setOrderItems(orderItems.map((item) => {
      if (item.id === id) {
        const updated = { ...item, [field]: value };
        return {
          ...updated,
          ...calcPrice(
            updated.sirka,
            updated.vyska,
            updated.kusy,
            updated.guideType,
            [updated.boxColor, updated.guideColor, updated.pancierColor, updated.endColor]
          )
        };
      }
      return item;
    }));
  };

  const deleteItem = (id) => {
    setOrderItems(orderItems.filter((item) => item.id !== id));
  };

  const accessoriesTotal = Object.entries(accessories).reduce((sum, [id, qty]) => {
    const acc = accessoriesList.find((a) => a.id === id);
    return sum + (acc ? acc.price * qty : 0);
  }, 0);

  const totalBezDPH = orderItems.reduce((sum, i) => sum + i.cenaBezDPH, 0) + accessoriesTotal;
  const totalSDPH = totalBezDPH * 1.21;

  return (
    <div className="max-w-5xl mx-auto p-6 bg-white rounded-2xl shadow">
      <h1 className="text-2xl font-bold mb-4">Konfigurátor rolety</h1>

      <div className="grid grid-cols-2 gap-4 mb-4">
        <label>
          Šířka (mm)
          <input type="number" value={sirka} onChange={(e) => setSirka(+e.target.value)} className="border p-2 w-full" />
        </label>
        <label>
          Výška (mm)
          <input type="number" value={vyska} onChange={(e) => setVyska(+e.target.value)} className="border p-2 w-full" />
        </label>
        <label>
          Počet kusů
          <input type="number" value={kusy} onChange={(e) => setKusy(+e.target.value)} className="border p-2 w-full" />
        </label>
      </div>

      <div className="mb-4 p-3 bg-blue-50 rounded-lg border">
        <p><strong>Minimální velikost boxu:</strong> {minBoxSize} mm</p>
      </div>

      <h2 className="font-semibold mt-4">Barvy</h2>
      <div className="grid grid-cols-2 gap-4">
        <label>
          Box
          <select value={boxColor} onChange={(e) => setBoxColor(e.target.value)} className="border p-2 w-full">
            {colors.map((c) => <option key={c}>{c}</option>)}
          </select>
        </label>
        <label>
          Vodící lišty
          <select value={guideColor} onChange={(e) => setGuideColor(e.target.value)} className="border p-2 w-full">
            {colors.map((c) => <option key={c}>{c}</option>)}
          </select>
        </label>
        <label>
          Pancíř
          <select value={pancierColor} onChange={(e) => setPancierColor(e.target.value)} className="border p-2 w-full">
            {colors.map((c) => <option key={c}>{c}</option>)}
          </select>
        </label>
        <label>
          Koncová lišta
          <select value={endColor} onChange={(e) => setEndColor(e.target.value)} className="border p-2 w-full">
            {colors.map((c) => <option key={c}>{c}</option>)}
          </select>
        </label>
      </div>

      <h2 className="font-semibold mt-4">Vodící lišty</h2>
      <select
        value={guideType}
        onChange={(e) => setGuideType(e.target.value)}
        className="border p-2 w-full"
        disabled={sirka > 2900}
      >
        <option value="PP53">PP53 (standard)</option>
        <option value="PP68">PP68 (širší)</option>
      </select>
      {sirka > 2900 && (
        <p className="text-sm text-red-600 mt-1">Pro šířku nad 2900 mm je povinná lišta PP68.</p>
      )}

      <div className="mt-6 p-4 bg-gray-100 rounded-lg">
        <p><strong>Cena bez DPH:</strong> {cenaBezDPH.toFixed(2)} Kč</p>
        <p><strong>Cena s DPH:</strong> {cenaSDPH.toFixed(2)} Kč</p>
      </div>

      <button onClick={addToOrder} className="mt-4 px-4 py-2 bg-green-600 text-white rounded-lg shadow">Přidat do objednávky</button>

      {orderItems.length > 0 && (
        <div className="mt-8">
          <h2 className="text-xl font-bold mb-2">Shrnutí objednávky</h2>
          <table className="w-full border-collapse border text-sm">
            <thead>
              <tr className="bg-gray-100">
                <th className="border p-2">Šířka</th>
                <th className="border p-2">Výška</th>
                <th className="border p-2">Box (mm)</th>
                <th className="border p-2">Kusy</th>
                <th className="border p-2">Barva boxu</th>
                <th className="border p-2">Barva lišt</th>
                <th className="border p-2">Barva pancíře</th>
                <th className="border p-2">Barva koncové lišty</th>
                <th className="border p-2">Lišta</th>
                <th className="border p-2">Cena bez DPH</th>
                <th className="border p-2">Cena s DPH</th>
                <th className="border p-2">Akce</th>
              </tr>
            </thead>
            <tbody>
              {orderItems.map((item) => (
                <tr key={item.id}>
                  <td className="border p-2">
                    <input type="number" value={item.sirka} onChange={(e) => updateItem(item.id, "sirka", +e.target.value)} className="border p-1 w-20" />
                  </td>
                  <td className="border p-2">
                    <input type="number" value={item.vyska} onChange={(e) => updateItem(item.id, "vyska", +e.target.value)} className="border p-1 w-20" />
                  </td>
                  <td className="border p-2">{getMinBoxSize(item.vyska)}</td>
                  <td className="border p-2">
                    <input type="number" value={item.kusy} onChange={(e) => updateItem(item.id, "kusy", +e.target.value)} className="border p-1 w-16" />
                  </td>
                  <td className="border p-2">
                    <select value={item.boxColor} onChange={(e) => updateItem(item.id, "boxColor", e.target.value)} className="border p-1">
                      {colors.map((c) => <option key={c}>{c}</option>)}
                    </select>
                  </td>
                  <td className="border p-2">
                    <select value={item.guideColor} onChange={(e) => updateItem(item.id, "guideColor", e.target.value)} className="border p-1">
                      {colors.map((c) => <option key={c}>{c}</option>)}
                    </select>
                  </td>
                  <td className="border p-2">
                    <select value={item.pancierColor} onChange={(e) => updateItem(item.id, "pancierColor", e.target.value)} className="border p-1">
                      {colors.map((c) => <option key={c}>{c}</option>)}
                    </select>
                  </td>
                  <td className="border p-2">
                    <select value={item.endColor} onChange={(e) => updateItem(item.id, "endColor", e.target.value)} className="border p-1">
                      {colors.map((c) => <option key={c}>{c}</option>)}
                    </select>
                  </td>
                  <td className="border p-2">
                    <select value={item.guideType} onChange={(e) => updateItem(item.id, "guideType", e.target.value)} className="border p-1" disabled={item.sirka > 2900}>
                      <option value="PP53">PP53</option>
                      <option value="PP68">PP68</option>
                    </select>
                  </td>
                  <td className="border p-2">{item.cenaBezDPH.toFixed(2)} Kč</td>
                  <td className="border p-2">{item.cenaSDPH.toFixed(2)} Kč</td>
                  <td className="border p-2 text-center">
                    <button onClick={() => deleteItem(item.id)} className="px-2 py-1 bg-red-500 text-white rounded">Smazat</button>
                  </td>
                </tr>
              ))}
            </tbody>
          </table>

          <div className="mt-6">
            <h3 className="text-lg font-semibold mb-2">Doplňky</h3>
            {accessoriesList.map((acc) => (
              <div key={acc.id} className="flex items-center justify-between mb-2">
                <span>{acc.name} ({acc.price} Kč/ks)</span>
                <input
                  type="number"
                  min="0"
                  value={accessories[acc.id] || 0}
                  onChange={(e) => setAccessories({ ...accessories, [acc.id]: +e.target.value })}
                  className="border p-1 w-20"
                />
              </div>
            ))}
          </div>

          <div className="mt-4 p-4 bg-gray-100 rounded-lg">
            <p><strong>Celkem bez DPH:</strong> {totalBezDPH.toFixed(2)} Kč</p>
            <p><strong>Celkem s DPH:</strong> {totalSDPH.toFixed(2)} Kč</p>
          </div>
        </div>
      )}
    </div>
  );
}
